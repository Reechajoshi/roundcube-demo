/**
 * New Mail Notifier plugin script
 *
 * @author Aleksander Machniak <alec@alec.pl>
 *
 * @licstart  The following is the entire license notice for the
 * JavaScript code in this file.
 *
 * Copyright (c) 2013, The Roundcube Dev Team
 *
 * The JavaScript code in this page is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in this file.
 */
window.rcmail&&"mail"==rcmail.env.task&&(rcmail.addEventListener("plugin.newmail_notifier",newmail_notifier_run),rcmail.addEventListener("actionbefore",newmail_notifier_stop),rcmail.addEventListener("init",function(){rcmail.message_list&&rcmail.message_list.addEventListener("select",newmail_notifier_stop)}));function newmail_notifier_run(a){a.basic&&newmail_notifier_basic();a.sound&&newmail_notifier_sound();a.desktop&&newmail_notifier_desktop(rcmail.gettext("body","newmail_notifier"))}
function newmail_notifier_stop(a){!rcmail.env.favicon_href||!rcmail.env.favicon_changed||a&&"check-recent"==a.action||($('<link rel="shortcut icon" href="'+rcmail.env.favicon_href+'"/>').replaceAll('link[rel="shortcut icon"]'),rcmail.env.favicon_changed=0);try{window.external.msIsSiteMode()&&window.external.msSiteModeClearIconOverlay()}catch(b){}}
function newmail_notifier_basic(){var a=rcmail.is_framed()?window.parent:window,b=rcmail.assets_path("plugins/newmail_notifier");a.focus();var d=$('<link rel="shortcut icon">').attr("href",b+"/favicon.ico"),a=$('link[rel="shortcut icon"]',a.document);rcmail.env.favicon_href||(rcmail.env.favicon_href=a.attr("href"));rcmail.env.favicon_changed=1;d.replaceAll(a);try{window.external.msIsSiteMode()&&window.external.msSiteModeSetIconOverlay(b+"/overlay.ico",rcmail.gettext("title","newmail_notifier"))}catch(c){}}
function newmail_notifier_sound(){var a,b=rcmail.assets_path("plugins/newmail_notifier/sound"),d=navigator.mimeTypes?navigator.mimeTypes["audio/mp3"]:{},b=b+(bw.ie||d&&d.enabledPlugin?".mp3":".wav");try{a=$("<audio>").attr("src",b),a.get(0).play()}catch(c){a=$('<embed id="sound" src="'+b+'" hidden=true autostart=true loop=false />'),a.appendTo($("body")),window.setTimeout("$('#sound').remove()",5E3)}}
function newmail_notifier_desktop(a){var b=rcmail.env.newmail_notifier_timeout||10,d=rcmail.assets_path("plugins/newmail_notifier/mail.png");try{if("granted"==Notification.permission||void 0==Notification.permission){var c=new Notification(rcmail.gettext("title","newmail_notifier"),{dir:"auto",lang:"",body:a,tag:"newmail_notifier",icon:d});c.onclick=function(){this.close()};setTimeout(function(){c.close()},1E3*b);if("granted"==c.permission)return!0}}catch(f){var e=window.webkitNotifications;if(e&&
!e.checkPermission())return rcmail.newmail_popup&&rcmail.newmail_popup.cancel(),c=window.webkitNotifications.createNotification(d,rcmail.gettext("title","newmail_notifier"),a),c.onclick=function(){this.cancel()},c.show(),setTimeout(function(){c.cancel()},1E3*b),rcmail.newmail_popup=c,!0}return!1}
function newmail_notifier_test_desktop(){var a=rcmail.gettext("testbody","newmail_notifier");try{var b=new window.Notification(a,{tag:"newmail_notifier"});("granted"!==Notification.permission||b.permission&&"granted"!==b.permission)&&newmail_notifier_desktop_authorize()}catch(d){(b=window.webkitNotifications)?b.checkPermission()?b.requestPermission(function(){newmail_notifier_desktop(a)||rcmail.display_message(rcmail.gettext("desktopdisabled","newmail_notifier"),"error")}):newmail_notifier_desktop(a):
rcmail.display_message(rcmail.gettext("desktopunsupported","newmail_notifier"),"error")}}function newmail_notifier_test_basic(){newmail_notifier_basic()}function newmail_notifier_test_sound(){newmail_notifier_sound()}function newmail_notifier_desktop_authorize(){Notification.requestPermission(function(a){"denied"==a&&rcmail.display_message(rcmail.gettext("desktopdisabled","newmail_notifier"),"error");"granted"==a&&newmail_notifier_test_desktop()})};
