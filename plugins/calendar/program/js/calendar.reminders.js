function calendar_reminders(){this.msgids=[];this.schedule=function(){rcmail.enable_command("send-attachment",!1);$("#attachment-form .mainaction").prop("disabled",!0);if("mail"==rcmail.env.task||"addressbook"==rcmail.env.task||"settings"==rcmail.env.task||"dummy"==rcmail.env.task)$("#remindersloading").html('<span class="smallreminders"align="center">'+rcmail.gettext("remindersloading","calendar")+"</span>"),$("#remindersloading").show(),"login"!=rcmail.env.task&&"logout"!=rcmail.env.task&&rcmail.http_request("plugin.calendar_get_reminders")};
this.remove=function(a,b){if(!(0<this.msgids.length))if(a){for(var c=1;5>c;c++)$("#rtr"+c+a).remove();0==$("#reminders li").size()&&($("#remindersoverlay").hide(),$("#remindersoverlaysmall").hide());$("#reminderscount").html($("#reminders li").size());this.msgids[this.msgids.length]=rcmail.set_busy(!0,"loading");rcmail.http_post("plugin.calendar_delete_reminder","_id="+a+"&_event_id="+b)}else this.msgids[this.msgids.length]=rcmail.set_busy(!0,"loading"),rcmail.http_post("plugin.calendar_delete_reminders",
"")};this.display=function(a){for(var b in calendar_reminders.msgids)rcmail.set_busy(!1,"loading",calendar_reminders.msgids[b]);calendar_reminders.msgids=[];rcmail.enable_command("send-attachment",!0);$("#remindersloading").hide();window.setTimeout("calendar_reminders.schedule()",6E4);$("#attachment-form .mainaction").prop("disabled",!1);if(a[1]&&!window.opener){var c='<table><tr><td width="98%" align="center"><b>'+rcmail.gettext("calendar.reminders")+'</b></td><td><a href="#"><span title="'+rcmail.gettext("calendar.minimize")+
"\" onclick=\"$('#reminderscount').html($('#reminders li').size());$('#remindersoverlay').hide();$('#remindersoverlaysmall').show()\" class=\"ui-icon ui-icon-minus\"></span></a></td></tr><tr><td align=\"center\">("+calendar_common.localeTimeString(new Date)+')</td></tr></table><div><div style="position:absolute; right: 20px;"><small>[<a href="#" onclick="calendar_reminders.remove()">'+rcmail.gettext("calendar.removereminders")+'</a>]</small></div></div><div id="reminderlist"><ul id="reminders"><table>',
e,j,f,l,d,h,g="remindersconfirmation";for(b in a[1])if(f=a[1][b].reminder_id,l=a[1][b].id,e="---",j="",a[1][b]){""!=a[1][b].title&&(e=a[1][b].title);a[1][b].end_unix||(a[1][b].end_unix=a[1][b].start_unix);d=new Date(1E3*a[1][b].start_unix);d=calendar_common.localeTimeString(d);h=new Date(1E3*a[1][b].end_unix);h=calendar_common.localeTimeString(h);duedate=!1;!0==a[1][b].duereminder&&(duedate=new Date(1E3*a[1][b].due),duedate=calendar_common.localeTimeString(duedate),d=!1);if(a[1][b].start_unix<(new Date).getTime()/
1E3&&(a[1][b].end_unix>=(new Date).getTime()/1E3||a[1][b].end_unix<=a[1][b].start_unix))j="started",e=e+" ("+rcmail.gettext("calendar.started")+")","remindersconfirmation"==g&&(g="remindersnotice");else if(a[1][b].start_unix<(new Date).getTime()/1E3&&(a[1][b].end_unix<(new Date).getTime()/1E3&&a[1][b].end_unix>a[1][b].start_unix)&&(j="terminated",e=e+" ("+rcmail.gettext("calendar.terminated")+")","remindersconfirmation"==g||"remindersnotice"==g))g="reminderswarning";c=c+'<tr id="rtr1'+f+'"><td colspan="4"><li id="rli'+
b+'" class="'+j+'">'+e+'</td></tr><tr id="rtr2'+f+'"><td rowspan="2"><span title="'+rcmail.gettext("calendar.noticed")+'" onclick="setTimeout(function() {calendar_reminders.remove(\''+f+"', '"+l+'\')},500)"><input type="checkbox" /></span></td><td>'+(d?rcmail.gettext("calendar.starts"):rcmail.gettext("calendar.due"))+"</td><td>"+rcmail.gettext("calendar.at")+'</td><td align="right">'+(d?d:duedate)+"</td></tr>"+(h>d?'<tr id="rtr3'+f+'"><td>'+rcmail.gettext("calendar.ends")+"</td><td>"+rcmail.gettext("calendar.at")+
'</td><td align="right">'+h+"</td></tr>":"")+'<tr id="rtr4'+f+'"><td colspan="4"><hr align="left" width="100%" /></li></td></tr>'}c+="</table></ul></div>";$("#remindersoverlay").html('<div id="reminderscontent">'+c+"</div>");c='<table><tr><td class="smallreminders" width="98%" align="center">'+rcmail.gettext("calendar.reminders")+'&nbsp;(<span id="reminderscount">'+$("#reminders li").size()+'</span>)</td><td><a href="#"><span title="'+rcmail.gettext("calendar.maximize")+'" onclick="$(\'#remindersoverlay\').show();$(\'#remindersoverlaysmall\').hide()" class="ui-icon ui-icon-plus"></span></a></td></tr></table>';
$("#remindersoverlaysmall").html(c);$("#remindersoverlaysmall").attr("class",g);for(b in a[1])calendar_common.qtip(a[1][b],$("#rli"+b),"reminders");if(a[0]){$("#remindersoverlay").show();$("#remindersoverlaysmall").hide();try{var k=$('<audio src="plugins/calendar/sound.wav" />');k.get(0).play()}catch(m){k=$('<embed id="sound" src="plugins/calendar/sound.wav" hidden=true autostart=true loop=false />'),k.appendTo($("body")),window.setTimeout("$('#sound').remove()",5E3)}}0<$("#reminders li").size()?
"none"==$("#remindersoverlay").css("display")&&($("#reminderscount").html($("#reminders li").size()),$("#remindersoverlaysmall").show()):($("#remindersoverlay").hide(),$("#remindersoverlaysmall").hide())}else $("#remindersoverlay").hide(),$("#remindersoverlaysmall").hide()}}calendar_reminders=new calendar_reminders;
$(document).ready(function(){rcmail.addEventListener("plugin.calendar_displayReminders",function(a){a&&calendar_reminders.display(a)});rcmail.addEventListener("init",function(){"compose"==rcmail.env.action&&(!0===rcmail.env.compose_newwindow||!0===rcmail.env.compose_extwin)||"terms"==rcmail.env.template||(self.location==parent.location||parent.roundcube_wrapper)&&window.setTimeout("calendar_reminders.schedule();",1500)})});